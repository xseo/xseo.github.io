<!DOCTYPE html>
<html>
  <head>
    <title>Unit testing AngularJS child directive that requires parent directive</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    <link href="/css/syntax.css" rel="stylesheet">
    <link href="/css/my.css" rel="stylesheet">
    <link rel="alternate" type="application/rss+xml" title="P/MEAN and co." href="http://demisx.github.io/feed.xml">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    <script src="/js/twitter.js"></script>
  </head>
  <body>
    <header>
      <nav class="navbar navbar-inverse navbar-static-top" role="navigation">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a href="/">
              <img src="/images/thumb_demisx.jpg" style="width:50px;float:left" class="visible-xs img-responsive" alt="demisx avatar">
              <span class="navbar-brand">P/MEAN and co.</span>
            </a>
          </div>

          <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
              <li class="active"><a href="/">Home</a></li>
              <!-- <li><a href="/contact/xxx">Contact</a></li> -->
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="/feed.xml"><i class="fa fa-rss fa-lg"></i> RSS</a></li>
              <li><a href="https://github.com/demisx" rel="me" target="_blank"><i class="fa fa-github fa-lg"></i> GitHub</a></li>
              <li><a href="https://twitter.com/demisx1" rel="me" target="_blank"><i class="fa fa-twitter fa-lg"></i> Twitter</a></li>
            </ul>
          </div><!--/.navbar-collapse -->
        </div>
      </nav>
    </header>

    <section id="main" class="container">
      
      <div class="container">
        <div class="row">
          <div id="about-me" class="col-xs-12  col-sm-3 col-sm-push-9 col-md-2 col-md-push-10 hidden-xs">
            <div class="thumbnail">
              <img src="/images/thumb_demisx.jpg" alt="demisx avatar">
              <div class="caption small">
                <b><u>#inspect:</u></b>
                <p>I am Dmitri Moore, full stack programmer. I've been coding for almost 
                2 decades now. I've seen many frameworks going from
                super popular to fairly forgotten. So far, P/MEAN is my favorite stack:<br/>
                <button type="button" class="btn btn-default btn-sm"><u>P</u>ostgreSQL</button>
                <button type="button" class="btn btn-default btn-sm"><u>M</u>ongoDB</button>
                <button type="button" class="btn btn-default btn-sm"><u>E</u>xpress</button>
                <button type="button" class="btn btn-default btn-sm"><u>A</u>ngularJS</button>
                
                <button type="button" class="btn btn-default btn-sm"><u>N</u>ode.js</button>
                <br/>Let's see how long this
                one is gonna stick around. <i class="fa fa-smile-o"></i></p>
              </div> 
            </div>
          </div>
          <div class="col-xs-12 col-sm-9 col-sm-pull-3 col-md-10 col-md-pull-2" id="main-content">
            <h2>Unit testing AngularJS child directive that requires parent directive</h2>
<hr>
<p class="meta">28 Oct 2014</p>

<div class="post">
<p>In AngularJS we can have one or more directives communicate with each other. This 
gives us an ability to create web components (hello AngularJS 2.0) that are built 
from multiple directives. In order to for a directive A to access the API methods 
defined in a controller of a directive B, the latter needs to define the <code>require:</code> 
property with a value set to the name of directive A and specify how the search
should be performed (in my example, I prefix directive name with <code>^^</code>, so the
search for controlelr is done on the parent DOM elements only). The compilation 
of directive B will fail if directive A controller cannot be found in the &quot;search path&quot;.</p>

<div class="alert alert-warning">
<i class="fa fa-bell-o fa-2x"></i>
  Please note, when using `require` property, the directives will share 
  <b>the same instance</b> of the controller.
</div>

<p>Here is an example of a directive B requiring presence of directive A controller
on a parent DOM element:</p>

<div class="highlight"><pre><code class="language-coffeescript" data-lang="coffeescript"><span class="lineno"> 1</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span> <span class="s">&#39;app.directives&#39;</span><span class="p">,</span> <span class="p">[]</span>
<span class="lineno"> 2</span> 
<span class="lineno"> 3</span> <span class="p">.</span><span class="nx">directive</span> <span class="s">&#39;directiveA&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
<span class="lineno"> 4</span>   <span class="nv">restrict: </span><span class="s">&#39;E&#39;</span>
<span class="lineno"> 5</span>   <span class="nv">controller: </span><span class="nf">-&gt;</span>
<span class="lineno"> 6</span>     <span class="vi">@add = </span><span class="nf">(x,y) -&gt;</span>
<span class="lineno"> 7</span>       <span class="nx">x</span><span class="o">+</span><span class="nx">y</span>
<span class="lineno"> 8</span>   <span class="k">return</span>
<span class="lineno"> 9</span>   
<span class="lineno">10</span> <span class="p">.</span><span class="nx">directive</span> <span class="s">&#39;directiveB&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
<span class="lineno">11</span>   <span class="nv">restrict: </span><span class="s">&#39;E&#39;</span>
<span class="lineno">12</span>   <span class="nv">require: </span><span class="s">&#39;^^directiveA&#39;</span> <span class="c1"># search for directive A controller on the parent elements</span>
<span class="lineno">13</span>   <span class="nv">link: </span><span class="nf">(scope, elem, attrs, ctrl) -&gt;</span>
<span class="lineno">14</span>     <span class="c1"># let&#39;s define some function on directive B scope </span>
<span class="lineno">15</span>     <span class="c1"># that leverages the business logic of directive A</span>
<span class="lineno">16</span>     <span class="nv">scope.letsAdd = </span><span class="nf">(x,y) -&gt;</span>
<span class="lineno">17</span>       <span class="nx">ctrl</span><span class="p">.</span><span class="nx">add</span> <span class="nx">x</span><span class="p">,</span><span class="nx">y</span>
<span class="lineno">18</span>     <span class="k">return</span></code></pre></div>

<p>And let&#39;s assume these two directives have simple &quot;parent-child&quot; relationship in HTML:</p>
<div class="highlight"><pre><code class="language-html" data-lang="html"><span class="nt">&lt;directive-a&gt;</span>
  <span class="nt">&lt;directive-b&gt;&lt;/directive-b&gt;</span>
<span class="nt">&lt;/directive-a&gt;</span>
</code></pre></div>
<p>The issue comes in when we want to unit test directive B in isolation, without 
compiling directive A and everything that may come with it. 
If we try to test directive B just as a standalone directive, the compilation 
will fail as expected with the 
<code>Controller &#39;directiveA&#39;, required by directive &#39;directiveB&#39;, can&#39;t be found!</code>
error due to the <code>require: ^^directiveA</code> property of the directive B.</p>

<p>To eleminate this error and still unit test directive B in isolation, 
we need to mock the directive A controller and add it 
to the data store of some parent DOM element, e.g. <code>&lt;fake-parent&gt;</code> (see below).
We don&#39;t care what this parent is, as long as we can put a controller mock into
its data strore (via <code>.data</code> method). </p>

<p>Note, the naming convention for the controller key looked up by Angular is: </p>

<p><code>&#39;$&#39; + name of directive + &#39;Controller&#39;</code>. </p>

<p>Therefore, in order for Angular to find the mocked directive A controller
and have our test pass, we&#39;d need to associate this mock 
with <code>$directiveAController</code> key in the parent element data store:</p>

<div class="highlight"><pre><code class="language-coffeescript" data-lang="coffeescript"><span class="lineno"> 1</span> <span class="nx">it</span><span class="p">.</span><span class="nx">only</span> <span class="s">&#39;ensures letsAdd can add two numbers&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
<span class="lineno"> 2</span>   <span class="nx">module</span> <span class="s">&#39;directives.cdSlideviewer&#39;</span> <span class="c1"># this usually goes into beforeEach block</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span>   <span class="c1"># mock directive A controller and spy on &#39;add&#39; method</span>
<span class="lineno"> 5</span>   <span class="nv">directiveAControllerMock =</span>
<span class="lineno"> 6</span>     <span class="nv">add: </span><span class="nf">-&gt;</span>
<span class="lineno"> 7</span>       <span class="mi">123</span> <span class="c1"># you can return anything here, since we are not unit testing it</span>
<span class="lineno"> 8</span>   
<span class="lineno"> 9</span>   <span class="c1"># create Sinon spy</span>
<span class="lineno">10</span>   <span class="nv">mySpy = </span><span class="nx">sinon</span><span class="p">.</span><span class="nx">spy</span> <span class="nx">directiveAControllerMock</span><span class="p">,</span> <span class="s">&#39;add&#39;</span>
<span class="lineno">11</span> 
<span class="lineno">12</span>   <span class="c1"># create angular element from HTML string</span>
<span class="lineno">13</span>   <span class="nv">elem = </span><span class="nx">angular</span><span class="p">.</span><span class="nx">element</span> <span class="s">&#39;&lt;fake-parent&gt;&lt;directive-b&gt;&lt;directive-b&gt;&lt;/fake-parent&gt;&#39;</span>
<span class="lineno">14</span>   
<span class="lineno">15</span>   <span class="c1"># put controller mock into &lt;fake-parent&gt; data store</span>
<span class="lineno">16</span>   <span class="nx">elem</span><span class="p">.</span><span class="nx">data</span> <span class="s">&#39;$directiveAController&#39;</span><span class="p">,</span> <span class="nx">directiveAControllerMock</span>
<span class="lineno">17</span>   
<span class="lineno">18</span>   <span class="c1"># compile element</span>
<span class="lineno">19</span>   <span class="nx">inject</span> <span class="nf">($compile, $rootScope) -&gt;</span>
<span class="lineno">20</span>     <span class="nx">$compile</span><span class="p">(</span><span class="nx">elem</span><span class="p">)</span> <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$new</span><span class="p">()</span>
<span class="lineno">21</span>     <span class="k">return</span>
<span class="lineno">22</span>   
<span class="lineno">23</span>   <span class="c1"># retrieve directive B element and its scope</span>
<span class="lineno">24</span>   <span class="nv">elem = </span><span class="nx">elem</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;directive-b&#39;</span>
<span class="lineno">25</span>   <span class="nv">scope = </span><span class="nx">elem</span><span class="p">.</span><span class="nx">scope</span><span class="p">()</span>
<span class="lineno">26</span> 
<span class="lineno">27</span>   <span class="c1"># call method under test</span>
<span class="lineno">28</span>   <span class="nx">scope</span><span class="p">.</span><span class="nx">letsAdd</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> 
<span class="lineno">29</span> 
<span class="lineno">30</span>   <span class="c1"># assert that our spy was called with proper arguments</span>
<span class="lineno">31</span>   <span class="nx">expect</span><span class="p">(</span><span class="nx">mySpy</span><span class="p">).</span><span class="nx">to</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">been</span><span class="p">.</span><span class="nx">calledWith</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span> <span class="c1"># </span>
<span class="lineno">32</span>   <span class="k">return</span></code></pre></div>

<p>The directive A controller is found and the test happily passes. <i class="fa fa-smile-o fa-lg" style="color:green"> </i></p>

<p>This was a contrived example inteded to demonstrate a high level approach on 
how one can remove a dependency on other directives during a unit test. Use
<a href="http://js2coffee.org/">js2coffe</a> if you need to convert my examples written in 
CoffeeScript to vanilla JavaScript and then learn CoffeeScript.</p></p>

<p><a class="twitter-follow-button"
  href="https://twitter.com/demisx1"
  data-show-count="false"
  data-lang="en"
  data-size="large">
</a> for more tips and best practices.</p>

<hr>

<p>Today my environment was:</p>

<ul>
<li>CoffeeScript 1.8.0</li>
<li>AngularJS 1.3.0</li>
<li>Node.js 0.10.31</li>
<li>Mocha 1.21.4 / Chai 1.9.2</li>
</ul>

</div>

<hr>
 <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'demisx'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'demisx'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function () {
      var s = document.createElement('script'); s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>
          </div>
        </div>
      </div>
        
      </div>
    </section>

    <footer>
      <div class="container">
        <hr>
        <div id="copyright">
          <p>&copy; 2014 All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>

    <!-- Google Analytics -->
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-47168884-1', 'demisx.github.io');
      ga('send', 'pageview');
    </script>
  </body>
</html>
